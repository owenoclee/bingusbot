<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>bingus debug</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-0: #0a0a0c;
  --bg-1: #111116;
  --bg-2: #1a1a22;
  --bg-3: #24242f;
  --border: #2a2a38;
  --border-focus: #4a4a6a;
  --text-0: #e8e8f0;
  --text-1: #a0a0b8;
  --text-2: #6a6a80;
  --accent: #7c6ff7;
  --accent-dim: #5a50b0;
  --green: #4ecf8b;
  --orange: #e8a44a;
  --red: #e85454;
  --blue: #5a9cf7;
  --cyan: #4ac8c8;
  --pink: #d06cc0;
  --yellow: #d4c85a;
  --mono: 'IBM Plex Mono', monospace;
  --sans: 'Space Grotesk', system-ui, sans-serif;
}

html, body { height: 100%; background: var(--bg-0); color: var(--text-0); font-family: var(--sans); }

body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto 1fr;
  gap: 0;
  height: 100vh;
  overflow: hidden;
}

/* ── Header bar ── */
header {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 20px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  z-index: 10;
}

header h1 {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--text-1);
  letter-spacing: 0.05em;
}

.ws-status {
  font-family: var(--mono);
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 3px;
  background: var(--bg-3);
  display: flex;
  align-items: center;
  gap: 6px;
}

.ws-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--red);
}

.ws-dot.connected { background: var(--green); }

/* ── Panel shared ── */
.panel {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}

.panel-left { border-right: 1px solid var(--border); }

.panel-header {
  padding: 12px 16px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--text-2);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

/* ── Chat panel ── */
#chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.chat-msg {
  max-width: 85%;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.5;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.chat-msg.user {
  align-self: flex-end;
  background: var(--accent-dim);
  color: var(--text-0);
  border-bottom-right-radius: 2px;
}

.chat-msg.agent {
  align-self: flex-start;
  background: var(--bg-2);
  color: var(--text-0);
  border-bottom-left-radius: 2px;
}

.chat-msg.system {
  align-self: center;
  background: none;
  color: var(--text-2);
  font-family: var(--mono);
  font-size: 12px;
  font-style: italic;
  padding: 4px 8px;
}

.chat-msg .msg-meta {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-2);
  margin-bottom: 2px;
}

.chat-input-area {
  padding: 12px 16px;
  background: var(--bg-1);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.chat-input-area textarea {
  flex: 1;
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-0);
  font-family: var(--sans);
  font-size: 14px;
  padding: 8px 12px;
  resize: none;
  outline: none;
  line-height: 1.4;
}

.chat-input-area textarea:focus { border-color: var(--border-focus); }

.chat-input-area button {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
}

.chat-input-area button:hover { background: var(--accent-dim); }
.chat-input-area button:disabled { opacity: 0.4; cursor: not-allowed; }

/* ── Inbox panel ── */
.inbox-toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.inbox-toolbar select,
.inbox-toolbar button {
  font-family: var(--mono);
  font-size: 11px;
  background: var(--bg-2);
  color: var(--text-0);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  outline: none;
}

.inbox-toolbar select:focus,
.inbox-toolbar button:focus { border-color: var(--border-focus); }

.inbox-toolbar button:hover { background: var(--bg-3); }

.inbox-toolbar .active { background: var(--accent-dim); border-color: var(--accent); }

#inbox-entries {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.inbox-entry {
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 8px 10px;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.5;
}

.inbox-entry-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
  font-size: 10px;
  color: var(--text-2);
}

.inbox-tag {
  padding: 1px 6px;
  border-radius: 3px;
  font-weight: 600;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.inbox-tag.user { background: #7c6ff720; color: var(--accent); }
.inbox-tag.assistant { background: #4ecf8b20; color: var(--green); }
.inbox-tag.system { background: #e8a44a20; color: var(--orange); }
.inbox-tag.tool_calls { background: #5a9cf720; color: var(--blue); }
.inbox-tag.tool_results { background: #4ac8c820; color: var(--cyan); }

.inbox-content {
  color: var(--text-0);
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* JSON syntax highlighting */
.json-string { color: var(--green); }
.json-number { color: var(--orange); }
.json-boolean { color: var(--pink); }
.json-null { color: var(--text-2); }
.json-key { color: var(--blue); }
.json-punctuation { color: var(--text-2); }

/* ── Insert modal ── */
.insert-bar {
  padding: 10px 16px;
  background: var(--bg-1);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  display: none;
  flex-direction: column;
  gap: 8px;
}

.insert-bar.open { display: flex; }

.insert-bar .insert-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.insert-bar select,
.insert-bar input {
  font-family: var(--mono);
  font-size: 12px;
  background: var(--bg-2);
  color: var(--text-0);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 6px 8px;
  outline: none;
}

.insert-bar select:focus,
.insert-bar input:focus { border-color: var(--border-focus); }

.insert-bar textarea {
  flex: 1;
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-0);
  font-family: var(--mono);
  font-size: 12px;
  padding: 8px;
  resize: none;
  outline: none;
  min-height: 60px;
  line-height: 1.4;
}

.insert-bar textarea:focus { border-color: var(--border-focus); }

.insert-bar button {
  font-family: var(--mono);
  font-size: 11px;
  background: var(--green);
  color: var(--bg-0);
  border: none;
  border-radius: 4px;
  padding: 6px 14px;
  cursor: pointer;
  font-weight: 600;
}

.insert-bar button:hover { opacity: 0.85; }

/* ── Scrollbar ── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-focus); }
</style>
</head>
<body>

<header>
  <h1>bingus // debug</h1>
  <div class="ws-status">
    <div class="ws-dot" id="ws-dot"></div>
    <span id="ws-label">disconnected</span>
  </div>
</header>

<!-- Chat panel -->
<div class="panel panel-left">
  <div class="panel-header">Chat</div>
  <div id="chat-messages"></div>
  <div class="chat-input-area">
    <textarea id="chat-input" rows="1" placeholder="Send a message..." disabled></textarea>
    <button id="chat-send" disabled>Send</button>
  </div>
</div>

<!-- Inbox panel -->
<div class="panel">
  <div class="panel-header">
    <span>Inbox Inspector</span>
    <div class="inbox-toolbar">
      <select id="inbox-filter">
        <option value="">all inboxes</option>
      </select>
      <button id="insert-toggle">+ insert</button>
    </div>
  </div>
  <div id="inbox-entries"></div>
  <div class="insert-bar" id="insert-bar">
    <div class="insert-row">
      <select id="insert-inbox">
        <option>user</option>
        <option>assistant</option>
        <option>system</option>
        <option>tool_calls</option>
        <option>tool_results</option>
      </select>
      <button id="insert-submit">Insert</button>
    </div>
    <textarea id="insert-content" placeholder="Content (plain text or JSON)..."></textarea>
  </div>
</div>

<script>
/*__CONFIG__*/

const CONFIG = window.__CONFIG__ || { wsAuthToken: '', wsPort: '8421' };
const WS_URL = `ws://${location.hostname}:${CONFIG.wsPort}`;

// ── Chat WS ──

const chatEl = document.getElementById('chat-messages');
const inputEl = document.getElementById('chat-input');
const sendBtn = document.getElementById('chat-send');
const wsDot = document.getElementById('ws-dot');
const wsLabel = document.getElementById('ws-label');

let ws = null;
let wsConnected = false;
let reconnectTimer = null;
const chatMessages = [];

function setWsStatus(connected) {
  wsConnected = connected;
  wsDot.classList.toggle('connected', connected);
  wsLabel.textContent = connected ? 'connected' : 'disconnected';
  inputEl.disabled = !connected;
  sendBtn.disabled = !connected;
}

function connectWs() {
  if (reconnectTimer) {
    clearTimeout(reconnectTimer);
    reconnectTimer = null;
  }
  // Detach old socket's handlers so its close doesn't trigger another reconnect
  if (ws) {
    ws.onclose = null;
    ws.onerror = null;
    ws.onmessage = null;
    try { ws.close(); } catch { /* already closed */ }
  }

  console.log('[ws] connecting to', WS_URL);
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    console.log('[ws] connected, sending auth');
    ws.send(JSON.stringify({ type: 'auth', token: CONFIG.wsAuthToken }));
  };

  ws.onmessage = (e) => {
    const frame = JSON.parse(e.data);

    if (frame.type === 'auth_ok') {
      setWsStatus(true);
      // Sync history
      ws.send(JSON.stringify({ type: 'sync', after: 0 }));
      return;
    }

    if (frame.type === 'auth_fail') {
      setWsStatus(false);
      wsLabel.textContent = 'auth failed';
      return;
    }

    if (frame.type === 'sync_response') {
      chatMessages.length = 0;
      for (const msg of frame.messages) {
        chatMessages.push(msg);
      }
      renderChat();
      return;
    }

    if (frame.type === 'message') {
      chatMessages.push(frame);
      renderChat();
      return;
    }
  };

  ws.onclose = (e) => {
    console.log('[ws] closed:', e.code, e.reason);
    setWsStatus(false);
    reconnectTimer = setTimeout(connectWs, 2000);
  };

  ws.onerror = (e) => {
    console.error('[ws] error:', e);
  };
}

function renderChat() {
  chatEl.innerHTML = '';
  for (const msg of chatMessages) {
    const div = document.createElement('div');
    const role = msg.role || 'system';
    div.className = `chat-msg ${role}`;

    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = `${role} · ${fmtTime(msg.createdAt)}`;
    div.appendChild(meta);

    const text = document.createElement('div');
    text.textContent = msg.content;
    div.appendChild(text);

    chatEl.appendChild(div);
  }
  chatEl.scrollTop = chatEl.scrollHeight;
}

function sendChat() {
  const text = inputEl.value.trim();
  if (!text || !wsConnected) return;
  ws.send(JSON.stringify({ type: 'message', text }));
  inputEl.value = '';
  autoResize();
}

sendBtn.addEventListener('click', sendChat);
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChat();
  }
});

function autoResize() {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
}
inputEl.addEventListener('input', autoResize);

connectWs();

// ── Inbox inspector ──

const inboxEntriesEl = document.getElementById('inbox-entries');
const inboxFilterEl = document.getElementById('inbox-filter');
const insertToggle = document.getElementById('insert-toggle');
const insertBar = document.getElementById('insert-bar');
const insertInbox = document.getElementById('insert-inbox');
const insertContent = document.getElementById('insert-content');
const insertSubmit = document.getElementById('insert-submit');

let inboxData = [];
let knownInboxes = new Set();

insertToggle.addEventListener('click', () => {
  insertBar.classList.toggle('open');
  insertToggle.classList.toggle('active');
});

insertSubmit.addEventListener('click', async () => {
  const inbox = insertInbox.value;
  const content = insertContent.value;
  if (!content) return;
  await fetch('/api/messages', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ inbox, content }),
  });
  insertContent.value = '';
  pollInbox();
});

async function loadInboxNames() {
  const res = await fetch('/api/inboxes');
  const names = await res.json();
  for (const name of names) {
    if (!knownInboxes.has(name)) {
      knownInboxes.add(name);
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      inboxFilterEl.appendChild(opt);
    }
  }
}

async function pollInbox() {
  const inbox = inboxFilterEl.value || null;
  const after = inboxData.length > 0 ? inboxData[inboxData.length - 1].created_at : 0;
  const params = new URLSearchParams();
  if (inbox) params.set('inbox', inbox);
  params.set('after', String(after));

  const res = await fetch(`/api/messages?${params}`);
  const rows = await res.json();

  if (rows.length > 0) {
    // When filter changes, we refetch from 0, so check if this is a full refresh
    if (after === 0) {
      inboxData = rows;
    } else {
      inboxData.push(...rows);
    }
    renderInbox();
  }
}

let currentFilter = '';
inboxFilterEl.addEventListener('change', () => {
  if (inboxFilterEl.value !== currentFilter) {
    currentFilter = inboxFilterEl.value;
    inboxData = [];
    pollInbox();
  }
});

function renderInbox() {
  inboxEntriesEl.innerHTML = '';
  for (const row of inboxData) {
    const el = document.createElement('div');
    el.className = 'inbox-entry';

    const header = document.createElement('div');
    header.className = 'inbox-entry-header';

    const tag = document.createElement('span');
    tag.className = `inbox-tag ${row.inbox}`;
    tag.textContent = row.inbox;
    header.appendChild(tag);

    const time = document.createElement('span');
    time.textContent = fmtTime(row.created_at);
    header.appendChild(time);

    const idSpan = document.createElement('span');
    idSpan.textContent = row.id.slice(0, 8);
    idSpan.style.opacity = '0.5';
    header.appendChild(idSpan);

    el.appendChild(header);

    const content = document.createElement('div');
    content.className = 'inbox-content';
    content.innerHTML = highlightContent(row.content);
    el.appendChild(content);

    inboxEntriesEl.appendChild(el);
  }
  inboxEntriesEl.scrollTop = inboxEntriesEl.scrollHeight;
}

// ── JSON highlighting ──

function highlightContent(str) {
  try {
    const parsed = JSON.parse(str);
    return highlightJson(parsed, 0);
  } catch {
    return escapeHtml(str);
  }
}

function highlightJson(val, depth) {
  if (val === null) return '<span class="json-null">null</span>';
  if (typeof val === 'boolean') return `<span class="json-boolean">${val}</span>`;
  if (typeof val === 'number') return `<span class="json-number">${val}</span>`;
  if (typeof val === 'string') return `<span class="json-string">"${escapeHtml(val)}"</span>`;

  const indent = '  '.repeat(depth + 1);
  const closingIndent = '  '.repeat(depth);

  if (Array.isArray(val)) {
    if (val.length === 0) return '<span class="json-punctuation">[]</span>';
    const items = val.map(v => indent + highlightJson(v, depth + 1));
    return '<span class="json-punctuation">[</span>\n' +
      items.join('<span class="json-punctuation">,</span>\n') +
      '\n' + closingIndent + '<span class="json-punctuation">]</span>';
  }

  const keys = Object.keys(val);
  if (keys.length === 0) return '<span class="json-punctuation">{}</span>';
  const entries = keys.map(k =>
    indent +
    '<span class="json-key">"' + escapeHtml(k) + '"</span>' +
    '<span class="json-punctuation">: </span>' +
    highlightJson(val[k], depth + 1)
  );
  return '<span class="json-punctuation">{</span>\n' +
    entries.join('<span class="json-punctuation">,</span>\n') +
    '\n' + closingIndent + '<span class="json-punctuation">}</span>';
}

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ── Helpers ──

function fmtTime(ms) {
  const d = new Date(ms);
  return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) +
    '.' + String(d.getMilliseconds()).padStart(3, '0');
}

// ── Polling loop ──

loadInboxNames();
pollInbox();

setInterval(() => {
  pollInbox();
  loadInboxNames();
}, 2000);
</script>
</body>
</html>
